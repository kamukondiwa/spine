<!DOCTYPE html>
<html>
    <head>
        <meta name="generator" content="HTML Tidy for HTML5 (experimental) for Windows https://github.com/w3c/tidy-html5/tree/c63cc39">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>
            Spine Strikr
        </title>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js" type="text/javascript"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
        <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js" type="text/javascript"></script>
        <style type="text/css" src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css"></style>
    </head>
    <body>
        <div class="container">
            <h1>
                Recent photos
            </h1>
            <div class="photos"></div>
        </div>
        <script type="text/template" id="photo-template">
        <%_.each(photos, function(photo){%>
          <h3><%= photo.get('title')%></h3>
          <img src="<%= photo.thumbnail_url()%>">
        <%});%>
        </script>
        <script type="text/javascript" charset="utf-8">
        	var Spine = Spine || {};

			(function($) {

				Spine.PhotoModel = Backbone.Model.extend({
					large_url: function() {
						return this.image_url('medium');
					},
					thumbnail_url: function() {
						return this.image_url('square');
					},
					image_url: function(size) {
						var size_code;
						switch (size) {
							case 'square':
								size_code = '_s';
								break;
							case 'medium':
								size_code = '_z';
								break;
							case 'large':
								size_code = '_b';
								break;
							default:
								size_code = '';
						}
						return 'http://farm' + this.get('farm') + '.static.flickr.com/' + this.get('server') + '/' + this.get('id') + '_' + this.get('secret') + size_code + '.jpg';
					}
				});	

				Spine.Photos = Backbone.Collection.extend({
					url: '/photos',
					model: Spine.PhotoModel
				});

				Spine.PhotosView = Backbone.View.extend({
					el: '.photos',
					initialize: function(options) {
						this.photos = new Spine.Photos();
					},
					render: function() {
						self = this;
						this.photos.fetch({
							data: {
								method: 'flickr.photos.getRecent',
								per_page: 10,
								page: 1
							},
							success: function(collection, response) {
								// collection.add(response.photos.photo);

								var model =  {
									photos: collection.models
								};
								var templateHtml = $('#photo-template').html();
								var template = _.template(templateHtml, model);
								self.$el.html(template);
							},
							error: function(collection, response, options) {
								console.log(response.responseText);
							}
						});
					}
				});

				Spine.Router = Backbone.Router.extend({
					initialize: function() {
						$.ajaxPrefilter(function(options, originalOptions, jqXHR) {
							options.url = 'http://api.flickr.com/services/rest/';
							options.crossDomain = true;

							var apiOptions = {
								api_key: 'eefd6fb1ac8895d7993c0826c56aafd7',
								format: 'json',
								nojsoncallback: 1
							};

							options.data = options.data + '&' || '';
							options.data = options.data + decodeURIComponent($.param(apiOptions));
						});

					},
					routes: {
						'': 'photos'
					}
				});

				var router = new Spine.Router();

				router.on('route:photos', function() {
					var photosView = new Spine.PhotosView();
					photosView.render();
				});

				Backbone.history.start();

			})(jQuery);
        </script>
    </body>
</html>